#! /bin/sh

# Clock
clock="%a %d %b %H:%M"

# Loop output to the panel
while : 
do

# Variables
a="$"
b=5
c=$a$b
n=0
biggestnr=0
nrofclients=0

# Determine the number of clients that are currently running
nrofclients=`xprop -root _NET_CLIENT_LIST | wc -w`
nrofclients=`expr $nrofclients - 4`

# Loop through the list of clients to fetch the client names and determine which workspaces are being used
for ((i=1;i<=$nrofclients;i++)) 
do
	clients[$n]=`xprop -root _NET_CLIENT_LIST | awk '{print '$c'}' | sed 's/,//g'`
	desktops[$n]=`xwininfo -id ${clients[$n]} -wm | grep Displayed | awk '{print $4}'`
	b=$(($b + 1))
	c=$a$b	
	n=$(($n + 1))
done

# Reset $n
n=0

# Loop through the workspace list to determine how many that are being used
for ((i=1;i<=$nrofclients;i++)) 
do
	if [ ${desktops[$n]} -gt $biggestnr ];
	then	
		biggestnr=${desktops[$n]}
	fi
	n=$(($n + 1))
done

# Save our output into a variable to pipe it to the panel
for ((i=0;i<=$biggestnr;i++))
do
	if [ $nrofclients -eq 0 ]; then
		ws="^bg(#d64937)^fg(#ffffff) ^i(/home/mikael/2bwm/circle.xbm)^fg(#d64937)^bg(#2d2d2d)^i(/home/mikael/2bwm/right_triangle.xbm)"
	elif [ `xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}'` -eq $i ] && [ $biggestnr -eq 0 ]; then
		ws="$ws^bg(#d64937)^fg(#ffffff) ^i(/home/mikael/2bwm/circle.xbm)^fg(#d64937)^bg(#2d2d2d)^i(/home/mikael/2bwm/right_triangle.xbm)"
	#elif [ `xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}'` -eq $i ] && [ $i -ge 1 ]; then
		#ws="$ws^fg(#d64937)^bg(#2d2d2d)^i(/home/mikael/2bwm/left_triangle.xbm)^bg(#d64937)^fg(#ffffff)^i(/home/mikael/2bwm/circle.xbm))^fg(#d64937)^bg(#2d2d2d)^i(/home/mikael/2bwm/right_triangle.xbm)^fg(#ffffff)"
	else	
		ws=$ws"^bg(#d64937)^fg(#ffffff)  ^i(/home/mikael/2bwm/circle_outline.xbm)  "
	fi
done

# Send the output
echo "$ws^bg(#d64937)^fg(#ffffff)^i(/home/mikael/2bwm/right_triangle.xbm)^pa(910)^fg(#d64937)^bg(#2d2d2d)^i(/home/mikael/2bwm/left_triangle.xbm)^fg(#ffffff)^bg(#d64937) Ã‰ $(clock) ^fg(#d64937)^bg(#2d2d2d)^i(/home/mikael/2bwm/right_triangle.xbm)"

# Reset variables and arrays
ws=""
biggestnr=0
unset clients
unset nrofclients
unset desktops

# Sleep for 0.5s before we start over
sleep 0.5

done
